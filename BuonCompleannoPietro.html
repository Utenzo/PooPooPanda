<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Puzzle di compleanno per Pietro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ffecd2 0%, #fcb69f 45%, #f2709c 100%);
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      color: #222;
    }

    .app {
      flex: 1;
      max-width: 900px;
      margin: 0 auto;
      padding: 12px 10px 20px;
      display: flex;
      flex-direction: column;
    }

    h1 {
      font-size: 1.8rem;
      margin: 0 0 8px;
      text-align: center;
      text-shadow: 0 2px 3px rgba(0,0,0,0.25);
      color: #fff;
    }

    .subtitle {
      text-align: center;
      font-size: 1rem;
      margin-bottom: 10px;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .card {
      background: rgba(255,255,255,0.9);
      border-radius: 16px;
      padding: 12px 14px 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      position: relative;
      flex-shrink: 0;
    }

    .signature {
      position: absolute;
      right: 12px;
      bottom: 8px;
      font-size: 0.78rem;
      color: #b34a7f;
      font-weight: 600;
      text-align: right;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
      color: #444;
    }

    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      outline: none;
    }

    input[type="text"]:focus {
      border-color: #ff6f61;
      box-shadow: 0 0 0 1px rgba(255,111,97,0.35);
    }

    .radio-group {
      display: flex;
      gap: 8px;
      margin: 4px 0 8px;
      flex-wrap: wrap;
    }

    .radio-pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border-radius: 999px;
      background: #ffe5de;
      border: 1px solid #ffb09f;
      font-size: 0.85rem;
      cursor: pointer;
      gap: 5px;
    }

    .radio-pill input {
      accent-color: #ff6f61;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #ff9a9e 0%, #ff6a88 50%, #ff99ac 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }

    button:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
    }

    button.secondary {
      background: #ffffff;
      color: #ff6f61;
      border: 1px solid #ffb5aa;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .menu-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .hint {
      font-size: 0.8rem;
      color: #666;
      margin-top: 4px;
    }

    .main-layout {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      min-height: 0;
    }

    #menu-screen {
      flex-shrink: 0;
    }

    #game-screen {
      display: none;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-height: 0;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 0.85rem;
    }

    .status-text {
      font-size: 0.85rem;
      color: #333;
    }

    .puzzle-wrapper {
      flex: 1;
      min-height: 260px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #puzzle-container {
      position: relative;
      width: min(90vw, 90vh);
      height: min(90vw, 90vh);
      max-width: 520px;
      max-height: 520px;
      background: #fdf2f2;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
    }

    :root {
      --rows: 3;
      --cols: 3;
    }

    .piece {
      position: absolute;
      width: calc(100% / var(--cols));
      height: calc(100% / var(--rows));
      overflow: hidden;
      transform-origin: center center;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      border: 1px solid rgba(255,255,255,0.6);
      background: #eee;
    }

    .piece-img {
      position: absolute;
      width: calc(100% * var(--cols));
      height: calc(100% * var(--rows));
      object-fit: fill;
      pointer-events: none;
    }

    .piece.selected {
      box-shadow: 0 0 0 3px #ffeb3b;
      z-index: 5;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .message {
      font-size: 0.9rem;
      text-align: center;
      margin-top: 4px;
      min-height: 1.2em;
      color: #333;
    }

    .hidden {
      display: none !important;
    }

    .win-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    .win-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .win-box {
      background: #fff;
      border-radius: 16px;
      padding: 14px 18px 12px;
      text-align: center;
      max-width: 260px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      animation: pop 0.35s ease-out;
    }

    .win-box h2 {
      margin: 0 0 4px;
      font-size: 1.2rem;
      color: #ff6f61;
    }

    .win-box p {
      margin: 0;
      font-size: 0.9rem;
    }

    @keyframes pop {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); }
    }

    @media (min-width: 700px) {
      h1 {
        font-size: 2.1rem;
      }
      .subtitle {
        font-size: 1.05rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Buon compleanno Pietro, 7 anni!</h1>
    <div class="subtitle">Puzzle speciale per il tuo giorno di festa üéà</div>

    <div class="card" id="menu-screen">
      <div class="signature">Da Enzo, Matilda e Valentina üíõ</div>

      <label for="image-url">URL immagine (lascia vuoto per usare quella di default)</label>
      <input type="text" id="image-url" placeholder="Incolla qui un link pubblico all'immagine..." />

      <div style="margin-top: 10px;">
        <label>Numero di pezzi</label>
        <div class="radio-group">
          <label class="radio-pill">
            <input type="radio" name="pieceCount" value="2" checked />
            Facile 2√ó2
          </label>
          <label class="radio-pill">
            <input type="radio" name="pieceCount" value="3" />
            Medio 3√ó3
          </label>
          <label class="radio-pill">
            <input type="radio" name="pieceCount" value="4" />
            Super 4√ó4
          </label>
        </div>
        <div class="hint">
          I pezzi rimangono grandi: √® pensato per bambini, niente cose impossibili üòâ
        </div>
      </div>

      <div class="menu-actions">
        <button id="start-btn">Inizia il puzzle üéÅ</button>
      </div>
    </div>

    <div class="main-layout">
      <div id="game-screen">
        <div class="top-bar">
          <div class="status-text" id="status-text">
            Tocca un pezzo per selezionarlo, poi un altro per scambiarli.
          </div>
          <button class="secondary" id="back-to-menu-btn">Nuova immagine</button>
        </div>

        <div class="puzzle-wrapper">
          <div id="puzzle-container">
            <div class="win-overlay" id="win-overlay">
              <div class="win-box">
                <h2>Bravo Pietro! üéâ</h2>
                <p>Hai completato il puzzle, sei un vero campione!</p>
              </div>
            </div>
          </div>
        </div>

        <div class="controls">
          <button id="rotate-btn">Ruota pezzo selezionato üîÑ</button>
          <button id="hint-btn">Aiutino ‚≠ê</button>
          <button class="secondary" id="reshuffle-btn">Rimescola</button>
        </div>

        <div class="message" id="message"></div>
      </div>
    </div>
  </div>

  <script>
    // üîß Default: invito di Pietro
    const DEFAULT_IMAGE_URL = "https://utenzo.github.io/PooPooPanda/IMG_20251206_092019.jpg";
    const fallbackImage = "https://images.pexels.com/photos/7972720/pexels-photo-7972720.jpeg?auto=compress&cs=tinysrgb&w=800";

    const root = document.documentElement;
    const startBtn = document.getElementById("start-btn");
    const backBtn = document.getElementById("back-to-menu-btn");
    const rotateBtn = document.getElementById("rotate-btn");
    const reshuffleBtn = document.getElementById("reshuffle-btn");
    const hintBtn = document.getElementById("hint-btn");
    const imageUrlInput = document.getElementById("image-url");
    const menuScreen = document.getElementById("menu-screen");
    const gameScreen = document.getElementById("game-screen");
    const puzzleContainer = document.getElementById("puzzle-container");
    const statusText = document.getElementById("status-text");
    const messageEl = document.getElementById("message");
    const winOverlay = document.getElementById("win-overlay");

    let currentRows = 3;
    let currentCols = 3;
    let pieces = [];
    let selectedPiece = null;
    let currentImageUrl = null;

    // ====== AUDIO RETRO (Web Audio API) ======
    let audioCtx = null;

    function ensureAudioContext() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return null;
        audioCtx = new AC();
      }
      return audioCtx;
    }

    function playBeep(freq, startTime, duration, type = "square", vol = 0.15) {
      const ctx = ensureAudioContext();
      if (!ctx) return;

      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.type = type;
      osc.frequency.setValueAtTime(freq, startTime);

      gain.gain.setValueAtTime(0, startTime);
      gain.gain.linearRampToValueAtTime(vol, startTime + 0.01);
      gain.gain.linearRampToValueAtTime(0.0001, startTime + duration);

      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start(startTime);
      osc.stop(startTime + duration + 0.02);
    }

    function playSound(name) {
      const ctx = ensureAudioContext();
      if (!ctx) return;
      const now = ctx.currentTime;

      switch (name) {
        case "start":
          playBeep(600, now, 0.08);
          playBeep(800, now + 0.1, 0.08);
          playBeep(1000, now + 0.2, 0.12);
          break;
        case "select":
          playBeep(700, now, 0.06);
          break;
        case "rotate":
          playBeep(900, now, 0.05);
          playBeep(600, now + 0.06, 0.05);
          break;
        case "swap":
          playBeep(650, now, 0.05);
          playBeep(850, now + 0.07, 0.07);
          break;
        case "shuffle":
          playBeep(900, now, 0.06);
          playBeep(700, now + 0.07, 0.06);
          break;
        case "hint":
          playBeep(500, now, 0.06);
          playBeep(750, now + 0.08, 0.08);
          break;
        case "win":
          playBeep(700, now, 0.08);
          playBeep(900, now + 0.09, 0.08);
          playBeep(1100, now + 0.18, 0.1);
          playBeep(1400, now + 0.3, 0.12);
          break;
      }
    }

    // ====== LOGICA PUZZLE ======
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function setPiecePosition(piece, rows, cols) {
      const r = parseInt(piece.dataset.row, 10);
      const c = parseInt(piece.dataset.col, 10);
      piece.style.top = (r * 100 / rows) + "%";
      piece.style.left = (c * 100 / cols) + "%";
    }

    function updatePieceRotation(piece) {
      const rot = parseInt(piece.dataset.rotation || "0", 10);
      piece.style.transform = "rotate(" + rot + "deg)";
    }

    function clearPuzzle() {
      pieces = [];
      selectedPiece = null;
      puzzleContainer.querySelectorAll(".piece").forEach(p => p.remove());
      winOverlay.classList.remove("visible");
      messageEl.textContent = "";
    }

    function buildPuzzle(imageUrl, rows, cols) {
      clearPuzzle();
      currentRows = rows;
      currentCols = cols;
      root.style.setProperty("--rows", rows);
      root.style.setProperty("--cols", cols);

      const coords = [];
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          coords.push({ row: r, col: c });
        }
      }

      coords.forEach(({row, col}) => {
        const piece = document.createElement("div");
        piece.className = "piece";
        piece.dataset.origRow = row;
        piece.dataset.origCol = col;
        piece.dataset.row = row;
        piece.dataset.col = col;
        piece.dataset.rotation = 0;

        const img = document.createElement("img");
        img.className = "piece-img";
        img.src = imageUrl;
        img.alt = "Puzzle";
        img.style.left = (-col * 100) + "%";
        img.style.top = (-row * 100) + "%";

        piece.appendChild(img);
        puzzleContainer.appendChild(piece);
        pieces.push(piece);
      });

      reshufflePieces(true);

      pieces.forEach(piece => {
        piece.addEventListener("click", () => onPieceClick(piece));
      });
    }

    function onPieceClick(piece) {
      if (winOverlay.classList.contains("visible")) return;

      // Sblocca audio su primo tocco
      ensureAudioContext();

      if (!selectedPiece) {
        selectedPiece = piece;
        piece.classList.add("selected");
        messageEl.textContent = "Ora tocca un altro pezzo per scambiarli, oppure premi \"Ruota\".";
        playSound("select");
      } else if (selectedPiece === piece) {
        piece.classList.remove("selected");
        selectedPiece = null;
        messageEl.textContent = "";
      } else {
        const r1 = selectedPiece.dataset.row;
        const c1 = selectedPiece.dataset.col;
        const r2 = piece.dataset.row;
        const c2 = piece.dataset.col;

        selectedPiece.dataset.row = r2;
        selectedPiece.dataset.col = c2;
        piece.dataset.row = r1;
        piece.dataset.col = c1;

        setPiecePosition(selectedPiece, currentRows, currentCols);
        setPiecePosition(piece, currentRows, currentCols);

        selectedPiece.classList.remove("selected");
        selectedPiece = null;
        messageEl.textContent = "";

        playSound("swap");
        checkWin();
      }
    }

    function rotateSelectedPiece() {
      if (!selectedPiece) {
        flashMessage("Seleziona prima un pezzo da ruotare.");
        return;
      }
      let rot = parseInt(selectedPiece.dataset.rotation || "0", 10);
      rot = (rot + 90) % 360;
      selectedPiece.dataset.rotation = rot;
      updatePieceRotation(selectedPiece);
      playSound("rotate");
      checkWin();
    }

    function reshufflePieces(initial = false) {
      if (pieces.length === 0) return;

      const coords = [];
      for (let r = 0; r < currentRows; r++) {
        for (let c = 0; c < currentCols; c++) {
          coords.push({ row: r, col: c });
        }
      }
      shuffleArray(coords);

      pieces.forEach((piece, index) => {
        const { row, col } = coords[index];
        piece.dataset.row = row;
        piece.dataset.col = col;
        setPiecePosition(piece, currentRows, currentCols);

        let rot = Math.floor(Math.random() * 4) * 90;
        piece.dataset.rotation = rot;
        updatePieceRotation(piece);
      });

      if (selectedPiece) {
        selectedPiece.classList.remove("selected");
        selectedPiece = null;
      }
      winOverlay.classList.remove("visible");
      messageEl.textContent = initial
        ? "Puzzle pronto! Tocca un pezzo per selezionarlo."
        : "Puzzle rimescolato! Buon divertimento üòÑ";

      if (!initial) playSound("shuffle");
    }

    function flashMessage(text) {
      messageEl.textContent = text;
      setTimeout(() => {
        if (messageEl.textContent === text) {
          messageEl.textContent = "";
        }
      }, 2000);
    }

    function checkWin() {
      if (pieces.length === 0) return;
      for (const piece of pieces) {
        const row = parseInt(piece.dataset.row, 10);
        const col = parseInt(piece.dataset.col, 10);
        const origRow = parseInt(piece.dataset.origRow, 10);
        const origCol = parseInt(piece.dataset.origCol, 10);
        const rot = parseInt(piece.dataset.rotation || "0", 10) % 360;
        if (row !== origRow || col !== origCol || rot !== 0) {
          return;
        }
      }
      showWin();
    }

    function showWin() {
      winOverlay.classList.add("visible");
      messageEl.textContent = "Puzzle completato! Puoi rimescolare o tornare al menu per cambiare immagine.";
      playSound("win");
    }

    // ====== AIUTINO: sistema un pezzo sbagliato ======
    function useHint() {
      if (pieces.length === 0) return;

      // Trova un pezzo non a posto
      let wrongPiece = null;
      for (const p of pieces) {
        const row = parseInt(p.dataset.row, 10);
        const col = parseInt(p.dataset.col, 10);
        const origRow = parseInt(p.dataset.origRow, 10);
        const origCol = parseInt(p.dataset.origCol, 10);
        const rot = parseInt(p.dataset.rotation || "0", 10) % 360;
        if (row !== origRow || col !== origCol || rot !== 0) {
          wrongPiece = p;
          break;
        }
      }

      if (!wrongPiece) {
        flashMessage("√à gi√† perfetto! üéâ");
        return;
      }

      const origRow = parseInt(wrongPiece.dataset.origRow, 10);
      const origCol = parseInt(wrongPiece.dataset.origCol, 10);

      // Pezzo che occupa la posizione corretta del wrongPiece
      let occupant = wrongPiece;
      for (const p of pieces) {
        if (p !== wrongPiece &&
            parseInt(p.dataset.row, 10) === origRow &&
            parseInt(p.dataset.col, 10) === origCol) {
          occupant = p;
          break;
        }
      }

      if (occupant !== wrongPiece) {
        // Scambia posizioni
        const r1 = wrongPiece.dataset.row;
        const c1 = wrongPiece.dataset.col;

        wrongPiece.dataset.row = origRow;
        wrongPiece.dataset.col = origCol;
        occupant.dataset.row = r1;
        occupant.dataset.col = c1;

        setPiecePosition(wrongPiece, currentRows, currentCols);
        setPiecePosition(occupant, currentRows, currentCols);
      }

      // Sistema rotazione
      wrongPiece.dataset.rotation = 0;
      updatePieceRotation(wrongPiece);

      if (selectedPiece) {
        selectedPiece.classList.remove("selected");
        selectedPiece = null;
      }

      messageEl.textContent = "Aiutino usato: un pezzo √® andato al posto giusto! ‚≠ê";
      playSound("hint");
      checkWin();
    }

    // ====== AVVIO / NAVIGAZIONE ======
    function startGame() {
      let url = imageUrlInput.value.trim();
      if (!url) {
        url = DEFAULT_IMAGE_URL || fallbackImage;
      }

      const selectedRadio = document.querySelector('input[name="pieceCount"]:checked');
      const gridSize = selectedRadio ? parseInt(selectedRadio.value, 10) : 3;

      currentImageUrl = url;
      statusText.textContent = `Griglia ${gridSize}√ó${gridSize} ‚Äî buon divertimento!`;

      const img = new Image();
      img.onload = function() {
        menuScreen.style.display = "none";
        gameScreen.style.display = "flex";
        buildPuzzle(currentImageUrl, gridSize, gridSize);
        playSound("start");
      };
      img.onerror = function() {
        flashMessage("Impossibile caricare l'immagine. Controlla il link.");
      };
      img.src = url;
    }

    function backToMenu() {
      gameScreen.style.display = "none";
      menuScreen.style.display = "block";
      clearPuzzle();
    }

    startBtn.addEventListener("click", startGame);
    backBtn.addEventListener("click", backToMenu);
    rotateBtn.addEventListener("click", rotateSelectedPiece);
    reshuffleBtn.addEventListener("click", () => reshufflePieces(false));
    hintBtn.addEventListener("click", useHint);
  </script>
</body>
</html>
