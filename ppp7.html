<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <title>Poo Poo Panda — cartoon sheet + responsive solido + fullscreen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <style>
    /* Layout contenitore */
    html,body{margin:0;height:100%;background:#0d1117}
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    #game-container{width:100vw;height:100dvh;min-height:100svh;display:flex;align-items:center;justify-content:center}
    @supports not (height: 100dvh){ #game-container{height:var(--vhpx)} }

    /* Overlay UI fuori dalla canvas */
    .hint{position:fixed;left:8px;bottom:74px;background:rgba(255,255,255,.92);padding:6px 8px;border-radius:8px;font-size:12px;z-index:50;pointer-events:none}
    #toolbar{position:fixed;left:50%;transform:translateX(-50%);bottom:8px;z-index:1000;display:none;gap:8px;padding:8px;border-radius:14px;background:rgba(10,14,19,.7);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.15)}
    #toolbar button{font:600 14px system-ui,Arial,sans-serif;padding:8px 10px;border-radius:12px;border:0;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.25);cursor:pointer;white-space:nowrap}
    #btn-menu,#btn-restart{background:#424242} #btn-poop{background:#a34a00}
    #btn-narwhal{background:#6a1b9a} #btn-siren{background:#2947a3} #btn-tornado{background:#00695c}
    #btn-full{position:fixed;right:8px;top:8px;z-index:1000;background:#263238;color:#fff;border:0;border-radius:10px;padding:8px 10px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.25)}
    #dl-sheet{position:fixed;right:8px;top:48px;z-index:1000;background:#1b5e20;color:#fff;border:0;border-radius:10px;padding:8px 10px;cursor:pointer;display:none}

    /* Audio gate per sbloccare su iOS/Android */
    .audio-unlock{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:999}
    .audio-unlock>button{font-size:18px;padding:10px 14px;border-radius:12px;border:0;background:#0a7d33;color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.35);cursor:pointer}
  </style>
</head>
<body>
  <div id="game-container"></div>

  <button id="btn-full" title="Schermo intero">⛶ Fullscreen</button>
  <button id="dl-sheet" title="Scarica sprite sheet generato">⬇️ Scarica icone Panda</button>

  <div id="toolbar" aria-label="Comandi di gioco">
    <button id="btn-menu">⬅ Menu</button>
    <button id="btn-restart">⟲ Ricomincia</button>
    <button id="btn-poop">💩</button>
    <button id="btn-narwhal">🐋</button>
    <button id="btn-siren">🧜‍♀️</button>
    <button id="btn-tornado">🌀</button>
  </div>

  <div id="audio-gate" class="audio-unlock"><button id="audio-btn">🔈 Tocca per attivare audio</button></div>
  <div class="hint">Tap/click per muovere • SPAZIO: 💩 • N: 🐋 • S: 🧜‍♀️ • T: 🌀</div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.87.0/dist/phaser.min.js"></script>

  <script type="module">
    const Phaser = window.Phaser;
    const FONT = "system-ui, -apple-system, Segoe UI, Arial, sans-serif";

    /* -------------------------------------------------------------
     *  RESPONSIVE “solido”: 2 layout separati
     *    - portrait: spiaggia 40% in basso (Land), 26% in alto (Sea)
     *    - landscape: proporzioni più panoramiche, margini maggiori
     * ----------------------------------------------------------- */
    const R = {
      metricsFor(scene){
        const { width, height } = scene.scale;
        const portrait = height >= width;
        if (scene.scene.key==='LandScene'){
          return portrait
            ? { seaStart: height*0.35, beachStart: height*0.60 }
            : { seaStart: height*0.40, beachStart: height*0.68 };
        } else if (scene.scene.key==='SeaScene'){
          return portrait
            ? { beachHeight: Math.floor(height*0.26) }
            : { beachHeight: Math.floor(height*0.22) };
        }
        return {};
      }
    };

    /* -------------------------------------------------------------
     *  Stato & regole base
     * ----------------------------------------------------------- */
    const Foods = { BAMBOO:'bamboo', PASTA:'pasta', PIZZA:'pizza', GELATO:'gelato' };
    function allowedFoodsFor(ch){ if(ch.specie==='panda') return new Set([Foods.BAMBOO]); if(ch.specie==='umano' && ch.eta==='piccolo') return new Set([Foods.PASTA]); if(ch.specie==='umano' && ch.eta==='adulto') return new Set([Foods.PIZZA]); return new Set(); }
    function poopGain(ch, f){ const ok=allowedFoodsFor(ch); if(ok.has(f)) return 0.18; if(f===Foods.GELATO) return 0.06; return 0; }

    const GameState = {
      selected:{ specie:'panda', eta:'piccolo', genere:'m' },
      poop:0, stomach:0,
      hasNarwhal:false, hasSiren:false, hasTornado:false, crabsFriendly:false,
      transitioning:false
    };
    function resetForNewRun(){
      GameState.poop=0; GameState.stomach=0;
      GameState.hasNarwhal=false; GameState.hasSiren=false; GameState.hasTornado=false; GameState.crabsFriendly=false;
      GameState.transitioning=false;
    }

    /* -------------------------------------------------------------
     *  Haptics & audio SFX leggeri
     * ----------------------------------------------------------- */
    const Haptics={ vib:(p)=>{try{navigator.vibrate&&navigator.vibrate(p)}catch{}}, wrong:()=>Haptics.vib(80), bonusPickup:()=>Haptics.vib(35), bonusUse:()=>Haptics.vib([30,50,30]), win:()=>Haptics.vib([30,70,30]), lose:()=>Haptics.vib([70,40,70]) };
    let _audioCtx=null; function ensureAudioContext(){ if(!_audioCtx) _audioCtx=new (window.AudioContext||window.webkitAudioContext)(); return _audioCtx; }
    function tone({freq=440,dur=0.12,type='sine',vol=0.22}){ const ctx=ensureAudioContext(), osc=ctx.createOscillator(), gain=ctx.createGain(); osc.type=type; osc.frequency.value=freq; osc.connect(gain); gain.connect(ctx.destination); gain.gain.setValueAtTime(vol,ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+dur); osc.start(); osc.stop(ctx.currentTime+dur); }
    const SFX={ play:(f,d,t,v)=>tone({freq:f,dur:d,type:t,vol:v}), eat(){this.play(520,0.08,'triangle',0.22);this.play(660,0.06,'sine',0.18)}, wrong(){this.play(220,0.10,'sawtooth',0.18)}, drop(){this.play(180,0.14,'square',0.22)}, narwhal(){this.play(400,0.10,'sine',0.2);this.play(300,0.20,'triangle',0.15)}, siren(){this.play(900,0.08,'square',0.2);this.play(700,0.12,'square',0.2)}, tornado(){this.play(120,0.30,'sawtooth',0.2)}, crab(){this.play(760,0.06,'square',0.22);this.play(640,0.08,'triangle',0.18)}, win(){[523,659,783].forEach((f,i)=>setTimeout(()=>this.play(f,0.12,'sine',0.22),i*120))}, lose(){[196,185,174].forEach((f,i)=>setTimeout(()=>this.play(f,0.12,'triangle',0.22),i*120))}, button(){this.play(540,0.08,'sine',0.22)} };

    /* -------------------------------------------------------------
     *  UI util
     * ----------------------------------------------------------- */
    function drawProgressBar(g, x, y, w, h, p, col=0x9b5a1a){
      g.lineStyle(2,0x222222,1); g.strokeRoundedRect(x,y,w,h,8);
      g.fillStyle(0x333333,1); g.fillRoundedRect(x,y,w,h,8);
      const pad=4, iw=(w-pad*2)*Phaser.Math.Clamp(p,0,1);
      g.fillStyle(col,1); g.fillRoundedRect(x+pad,y+pad,iw,h-pad*2,6);
    }

    /* -------------------------------------------------------------
     *  Sprite-sheet: carica da file; se manca, genera un fallback
     *  – Formato atteso: 6×4 frame, ciascuno 128×128, trasparente
     *  – Animazioni: walk_m/f, swim_m/f
     * ----------------------------------------------------------- */
    const SHEET = { key:'panda_icon', file:'panda_icon.png', cols:6, rows:4, cell:128 };

    function genFallbackSheetToDataURL(){
      // Disegno cartoon semplice (panda in 4 stati) su canvas 768×512
      const w=SHEET.cols*SHEET.cell, h=SHEET.rows*SHEET.cell;
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      const ctx=c.getContext('2d'); ctx.clearRect(0,0,w,h);
      const drawPanda=(cx,cy,withBow=false,swim=false,step=0)=>{
        ctx.save();
        ctx.translate(cx,cy);
        // leggero "bounce" per simulare 6 frame
        const bounce = swim ? Math.sin((step/6)*Math.PI*2)*3 : Math.sin((step/6)*Math.PI*2)*2;
        ctx.translate(0,bounce);
        // ombra
        ctx.fillStyle="rgba(0,0,0,0.20)"; ctx.beginPath(); ctx.ellipse(0,44,34,12,0,0,Math.PI*2); ctx.fill();
        // corpo
        ctx.fillStyle="#f7f7f7"; ctx.beginPath(); ctx.ellipse(0,0,36,34,0,0,Math.PI*2); ctx.fill();
        ctx.fillStyle="#333"; ctx.beginPath(); ctx.ellipse(-10,-4,12,14,0,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(12,2,14,16,0,0,Math.PI*2); ctx.fill();
        // testa
        ctx.fillStyle="#f7f7f7"; ctx.beginPath(); ctx.ellipse(10,-26,22,20,0,0,Math.PI*2); ctx.fill();
        ctx.fillStyle="#333"; // orecchie + patch occhi
        ctx.beginPath(); ctx.ellipse(-2,-40,7,7,0,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(22,-40,7,7,0,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(3,-27,6,7,0,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(16,-27,6,7,0,0,Math.PI*2); ctx.fill();
        // occhi
        ctx.fillStyle="#000"; ctx.beginPath(); ctx.arc(3,-27,2,0,Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(16,-27,2,0,Math.PI*2); ctx.fill();
        // naso
        ctx.beginPath(); ctx.arc(10,-22,2,0,Math.PI*2); ctx.fill();
        // bow
        if(withBow){
          ctx.fillStyle="#ff4aa4";
          ctx.beginPath(); ctx.ellipse(0,-44,7,6,0,0,Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.ellipse(10,-44,7,6,0,0,Math.PI*2); ctx.fill();
          ctx.fillStyle="#e81b89"; ctx.beginPath(); ctx.arc(5,-44,3,0,Math.PI*2); ctx.fill();
        }
        // acqua per swim
        if(swim){
          ctx.fillStyle="rgba(64,160,255,0.35)";
          ctx.beginPath(); ctx.ellipse(0,48,40,10,0,0,Math.PI*2); ctx.fill();
        }
        ctx.restore();
      };
      for(let r=0;r<SHEET.rows;r++){
        for(let cidx=0;cidx<SHEET.cols;cidx++){
          const x=cidx*SHEET.cell + SHEET.cell/2;
          const y=r*SHEET.cell + SHEET.cell/2 - 10;
          const step=cidx%6;
          if(r===0) drawPanda(x,y,false,false,step);    // maschio walk
          if(r===1) drawPanda(x,y,true,false,step);     // femmina walk
          if(r===2) drawPanda(x,y,false,true,step);     // maschio swim
          if(r===3) drawPanda(x,y,true,true,step);      // femmina swim
        }
      }
      return c.toDataURL("image/png");
    }

    class BootScene extends Phaser.Scene{
      constructor(){ super('Boot'); }
      preload(){
        // Prova a caricare lo spritesheet esterno
        this.load.spritesheet(SHEET.key, SHEET.file, { frameWidth:SHEET.cell, frameHeight:SHEET.cell });
        // Se fallisce, generiamo un fallback e mostriamo pulsante "Scarica icone Panda"
        this.load.on('loaderror', file=>{
          if(file?.key===SHEET.key){
            const url=genFallbackSheetToDataURL();
            document.getElementById('dl-sheet').style.display='inline-block';
            document.getElementById('dl-sheet').onclick=()=>{
              const a=document.createElement('a'); a.href=url; a.download='panda_icon.png'; a.click();
            };
            // Registra il PNG come texture singola, poi crea frame manuali
            this.textures.addBase64(SHEET.key, url);
            const tex=this.textures.get(SHEET.key);
            const w=SHEET.cols*SHEET.cell, h=SHEET.rows*SHEET.cell;
            // Crea 24 frame numerati 0..23 (6×4)
            let id=0;
            for(let ry=0;ry<SHEET.rows;ry++){
              for(let rx=0;rx<SHEET.cols;rx++){
                tex.add(id.toString(), 0, rx*SHEET.cell, ry*SHEET.cell, SHEET.cell, SHEET.cell);
                id++;
              }
            }
          }
        });
      }
      create(){
        // Filtro NEAREST = niente “bleed”
        if (this.textures.exists(SHEET.key)) {
          this.textures.get(SHEET.key).setFilter(Phaser.Textures.FilterMode.NEAREST);
        }
        // Animazioni (funzionano sia con spritesheet che con frame manuali)
        const A=this.anims;
        const mk=(key,start,end)=>{ if(!A.exists(key)) A.create({key, frames:Array.from({length:end-start+1},(_,i)=>({key:SHEET.key, frame:(start+i).toString?.() ?? start+i})), frameRate:8, repeat:-1}); };
        mk('walk_m',0,5); mk('walk_f',6,11); mk('swim_m',12,17); mk('swim_f',18,23);

        this.scene.start('MenuScene');
      }
    }

    /* -------------------------------------------------------------
     *  Componenti menu (selezione 1-tap ben evidenziata)
     * ----------------------------------------------------------- */
    function drawCardBG(g, w, h, active){
      g.clear();
      if(active){
        g.fillStyle(0x0e3a5a,1).fillRoundedRect(0,0,w,h,16);
        g.lineStyle(4,0x9be7ff,1).strokeRoundedRect(0,0,w,h,16);
        g.fillStyle(0x9be7ff,.22).fillRoundedRect(3,3,w-6,h-6,14);
      }else{
        g.fillStyle(0x102131,1).fillRoundedRect(0,0,w,h,16);
        g.lineStyle(2,0x5dade2,1).strokeRoundedRect(0,0,w,h,16);
      }
    }

    class MenuScene extends Phaser.Scene{
      constructor(){ super('MenuScene'); }
      create(){
        hideToolbar(); resetForNewRun();
        const {width,height}=this.scale;
        this.cameras.main.setBackgroundColor('#0d1117');
        // sfondo a bande
        const g=this.add.graphics();
        g.fillStyle(0x0b3d91,1).fillRect(0,0,width,height*0.35);
        g.fillStyle(0x1976d2,1).fillRect(0,height*0.35,width,height*0.25);
        g.fillStyle(0xf4e2b5,1).fillRect(0,height*0.60,width,height*0.40);

        // titolo
        this.add.text(width/2,56,'Poo Poo Panda',{fontFamily:FONT,fontSize:52,color:'#fff'}).setOrigin(0.5).setShadow(3,3,'#000',6,true,true);

        // pannello
        const panelW=Math.min(760,width-40), panelH=320, px=(width-panelW)/2, py=140;
        const panel=this.add.graphics(); panel.fillStyle(0x1b2838,.96).fillRoundedRect(px,py,panelW,panelH,20); panel.lineStyle(3,0x64b5f6,1).strokeRoundedRect(px,py,panelW,panelH,20);
        this.add.text(width/2,py+16,'Scegli personaggio e genere',{fontFamily:FONT,fontSize:20,color:'#e3f2fd'}).setOrigin(0.5);

        const options=[ {label:'Panda piccolo', value:{specie:'panda',eta:'piccolo'}}, {label:'Panda adulto', value:{specie:'panda',eta:'adulto'}}, {label:'Bambino umano', value:{specie:'umano',eta:'piccolo'}}, {label:'Adulto umano', value:{specie:'umano',eta:'adulto'}} ];
        let selectedIdx=0, gender='m';
        const startX=px+20, startY=py+84, gapX=(panelW-40)/4, cardW=(gapX-10), cardH=122;

        const cards=[];
        for(let i=0;i<options.length;i++){
          const x=startX+i*gapX, y=startY;
          const c=this.add.container(x,y);
          const bg=this.add.graphics(); c.add(bg);
          const img = this.add.sprite(cardW/2,48,SHEET.key,'2').setVisible(options[i].value.specie==='panda'); c.add(img);
          const txt=this.add.text(cardW/2, cardH-18, options[i].label, {fontFamily:FONT,fontSize:15,color:'#e3f2fd'}).setOrigin(0.5).setShadow(2,2,'#000',4,true,true); c.add(txt);
          c.setSize(cardW,cardH);
          c.refresh=()=>{
            drawCardBG(bg,cardW,cardH,(cards.indexOf(c)===selectedIdx));
            const sel={...options[i].value, genere: gender};
            if(sel.specie==='panda'){
              const frame = (sel.genere==='f')? '8' : '2';
              img.setTexture(SHEET.key,frame).setVisible(true).setScale(0.60);
            } else {
              img.setVisible(false);
            }
          };
          c.refresh();
          const zone=this.add.zone(0,0,cardW,cardH).setOrigin(0).setInteractive({useHandCursor:true}).on('pointerdown',()=>{SFX.button(); selectedIdx=i; cards.forEach(k=>k.refresh());});
          c.add(zone);
          cards.push(c);
        }

        const pillW=240, pillH=40, pillX=width/2-pillW/2, pillY=py+panelH-58, pill=this.add.graphics();
        const drawPill=()=>{ pill.clear(); pill.fillStyle(0x102131,1).fillRoundedRect(pillX,pillY,pillW,pillH,20); pill.lineStyle(2,0x90caf9,1).strokeRoundedRect(pillX,pillY,pillW,pillH,20); const knobX=gender==='m'?pillX+pillW*0.25:pillX+pillW*0.75; pill.fillStyle(0x64b5f6,1).fillRoundedRect(knobX-46,pillY+6,92,pillH-12,16); };
        drawPill();
        this.add.text(pillX+pillW*0.25,pillY+pillH/2,'♂️ Maschio',{fontFamily:FONT,fontSize:16,color:'#e3f2fd'}).setOrigin(0.5);
        this.add.text(pillX+pillW*0.75,pillY+pillH/2,'♀️ Femmina',{fontFamily:FONT,fontSize:16,color:'#e3f2fd'}).setOrigin(0.5);
        this.add.zone(pillX,pillY,pillW,pillH).setOrigin(0).setInteractive({useHandCursor:true}).on('pointerdown',()=>{ SFX.button(); gender=(gender==='m')?'f':'m'; cards.forEach(c=>c.refresh()); drawPill(); });

        const start=this.add.text(width/2,height-64,'Inizia ▶',{fontFamily:FONT,fontSize:30,color:'#fff',backgroundColor:'#43a047',padding:{left:18,right:18,top:8,bottom:8}}).setOrigin(0.5).setShadow(3,3,'#1b5e20',6,true,true);
        const goStart=()=>{ if(GameState.transitioning) return; GameState.transitioning=true; SFX.button(); const chosen=options[selectedIdx].value; GameState.selected={specie:chosen.specie,eta:chosen.eta,genere:gender}; this.scene.start('LandScene'); };
        start.setInteractive({useHandCursor:true}).on('pointerdown',goStart);

        this.scale.on('resize', ({width:W,height:H})=>{ start.setPosition(W/2,H-64); });
      }
    }

    /* -------------------------------------------------------------
     *  Land (terra) — movimento “stabile” come le versioni buone
     * ----------------------------------------------------------- */
    class LandScene extends Phaser.Scene{
      constructor(){ super('LandScene'); }
      create(){
        hideToolbar(); GameState.transitioning=false;
        const {width,height}=this.scale;
        this.cameras.main.setBackgroundColor('#87CEEB');

        const M=R.metricsFor(this); // sezioni stabili portrait/landscape
        const bg=this.add.graphics();
        bg.fillStyle(0x1976d2,1).fillRect(0,M.seaStart,width,(M.beachStart-M.seaStart));
        bg.fillStyle(0xF4E2B5,1).fillRect(0,M.beachStart,width,height-M.beachStart);

        // player
        const baseSize = (height>=width) ? 64 : 56; // un pelo più piccolo in landscape
        const scaleP= baseSize / SHEET.cell;
        const player=this.add.sprite(width/2, M.beachStart, SHEET.key, '2').setScale(scaleP);
        this.player=player; this.physics.add.existing(player);
        player.body.setCircle(player.displayWidth/2).setCollideWorldBounds(true);
        player.play(GameState.selected.genere==='f' ? 'walk_f' : 'walk_m');

        // UI destro (barre in alto)
        this.ui=this.add.graphics();
        this.poopText=this.add.text(0,0,'',{fontFamily:FONT,fontSize:14,color:'#ffffff'}).setOrigin(1,0).setStroke('#111',4).setShadow(2,2,'#000',4);
        this.stomachText=this.add.text(0,0,'',{fontFamily:FONT,fontSize:14,color:'#ffffff'}).setOrigin(1,0).setStroke('#111',4).setShadow(2,2,'#000',4);

        // Vai al mare (in alto centro)
        this.seaBtn=this.add.text(width/2,12,'Vai al Mare ▶',{fontFamily:FONT,fontSize:18,color:'#fff',backgroundColor:'#0a7d33',padding:{left:12,right:12,top:6,bottom:6}})
          .setOrigin(0.5,0).setDepth(1000).setAlpha(0.0);
        this.seaHotZone=this.add.zone(width/2,12,300,44).setOrigin(0.5,0).setInteractive({useHandCursor:true}).setDepth(1001).on('pointerdown',()=>this.tryGoSea());
        this.seaHotZone.setVisible(false);

        // Prompt
        this.promptText=this.add.text(width/2,48,'',{fontFamily:FONT,fontSize:16,color:'#001',backgroundColor:'#fff',padding:{left:8,right:8,top:4,bottom:4}}).setOrigin(0.5);

        // Ricomincia
        this.restartBtn=this.add.text(16,height-44,'⟲ Ricomincia (R)',{fontFamily:FONT,fontSize:18,color:'#fff',backgroundColor:'#444',padding:{left:10,right:10,top:6,bottom:6}})
          .setInteractive({useHandCursor:true}).on('pointerdown',()=>{ resetForNewRun(); this.scene.restart(); });

        // Cibo
        this.foods=this.physics.add.group(); this.bonuses=this.physics.add.group();
        this.sceneStartMs=this.time.now; this.GRACE_MS=1000; this.EAT_COOLDOWN_MS=180; this.lastEatMs=0;
        this.spawnFoodWave(); this.spawnBonusNarwhal();

        // Input stabile: tastiera + tap-to-move senza drift
        this.cursors=this.input.keyboard.createCursorKeys(); this.wasd=this.input.keyboard.addKeys('W,A,S,D');
        this.input.keyboard.on('keydown-M', ()=> this.tryGoSea());
        this.pointerTarget=null; this.pointerMarker=this.add.circle(0,0,8,0x000000,0.25).setVisible(false);
        const setPointer=(p)=>{ this.pointerTarget={x:p.worldX,y:p.worldY}; this.pointerMarker.setPosition(this.pointerTarget.x,this.pointerTarget.y).setVisible(true); };
        this.input.on('pointerdown',setPointer); this.input.on('pointermove',(p)=>{ if(p.isDown) setPointer(p); });

        this.physics.add.overlap(this.player,this.foods,this.onEatFood,null,this);
        this.physics.add.overlap(this.player,this.bonuses,this.onTakeBonus,null,this);
      }
      getSafeSpawn(minDist=120){ const {width,height}=this.scale; const M=R.metricsFor(this); const b={xMin:40,xMax:width-40,yMin:M.seaStart+20,yMax:height-40}; return randomPointAvoiding({x:this.player.x,y:this.player.y},minDist,b); }
      spawnFoodWave(){ const types=[Foods.BAMBOO,Foods.PASTA,Foods.PIZZA,Foods.GELATO]; for(let i=0;i<8;i++){ const t=Phaser.Utils.Array.GetRandom(types); const p=this.getSafeSpawn(140); this.spawnFoodAt(p.x,p.y,t);} }
      spawnFoodAt(x,y,t){ const txt=this.add.text(x,y, labelForFood(t), {fontFamily:FONT,fontSize:18,color:colorForFood(t)}).setOrigin(0.5); this.physics.add.existing(txt); txt.body.setCircle(24).setOffset(-24,-24).setImmovable(true); txt.foodType=t; this.foods.add(txt); }
      spawnSingleFood(){ const types=[Foods.BAMBOO,Foods.PASTA,Foods.PIZZA,Foods.GELATO]; const t=Phaser.Utils.Array.GetRandom(types); const p=this.getSafeSpawn(120); this.spawnFoodAt(p.x,p.y,t); }
      spawnBonusNarwhal(){ if(GameState.hasNarwhal) return; const p=this.getSafeSpawn(160); const b=this.add.text(p.x,p.y,'🐋 Narvalo',{fontFamily:FONT,fontSize:18,color:'#551a8b'}).setOrigin(0.5); this.physics.add.existing(b); b.body.setCircle(26).setOffset(-26,-26).setImmovable(true); b.bonusType='narwhal'; this.bonuses.add(b);}

      onEatFood(_,food){ const now=this.time.now; if(now-this.sceneStartMs<this.GRACE_MS) return; if(now-this.lastEatMs<this.EAT_COOLDOWN_MS) return; this.lastEatMs=now; const gain=poopGain(GameState.selected,food.foodType);
        if(gain===0){ GameState.stomach=Math.min(1,GameState.stomach+0.22); this.tweens.add({targets:food,angle:10,yoyo:true,duration:120,onComplete:()=>food.destroy()}); SFX.wrong(); Haptics.wrong();}
        else { GameState.poop=Math.min(1,GameState.poop+gain); this.tweens.add({targets:food,scale:1.25,yoyo:true,duration:120,onComplete:()=>food.destroy()}); SFX.eat(); }
        this.time.delayedCall(300,()=>this.spawnSingleFood());
      }
      onTakeBonus(_,bonus){ if(bonus.bonusType==='narwhal'){ GameState.hasNarwhal=true; this.tweens.add({targets:bonus,angle:360,scale:1.5,duration:240,onComplete:()=>bonus.destroy()}); SFX.narwhal(); Haptics.bonusPickup(); } }
      tryGoSea(){ if(GameState.poop<0.6 || GameState.transitioning) return; GameState.transitioning=true; this.scene.stop('LandScene'); this.scene.start('SeaScene'); }
      update(_,delta){
        const {width,height}=this.scale; const M=R.metricsFor(this);
        const body=this.player.body; body.setVelocity(0);
        const inWater=(this.player.y>=M.seaStart && this.player.y<=M.beachStart);
        const speed=inWater?110:160;

        if(this.cursors.left.isDown||this.wasd.A.isDown) body.setVelocityX(-speed); else if(this.cursors.right.isDown||this.wasd.D.isDown) body.setVelocityX(speed);
        if(this.cursors.up.isDown||this.wasd.W.isDown) body.setVelocityY(-speed); else if(this.cursors.down.isDown||this.wasd.S.isDown) body.setVelocityY(speed);

        if(this.pointerTarget){ const dx=this.pointerTarget.x-this.player.x, dy=this.pointerTarget.y-this.player.y, d=Math.hypot(dx,dy); if(d>6){ body.setVelocity((dx/d)*speed,(dy/d)*speed); } else { this.pointerTarget=null; this.pointerMarker.setVisible(false);} }

        // HUD destro + bottone mare
        const barW=220, barH=22, pad=16, xRight=width-barW-pad;
        this.ui.clear();
        drawProgressBar(this.ui,xRight,12,barW,barH,GameState.poop,0x9b5a1a);
        drawProgressBar(this.ui,xRight,12+barH+6,barW,barH,GameState.stomach,0xcc3333);
        this.poopText.setPosition(xRight+barW,12).setText(`Pupù: ${Math.round(GameState.poop*100)}%`);
        this.stomachText.setPosition(xRight+barW,12+barH+6).setText(`Mal di pancia: ${Math.round(GameState.stomach*100)}%`);
        const canSea=GameState.poop>=0.6;
        this.seaBtn.setAlpha(canSea?1:0); this.seaHotZone.setVisible(canSea);
        this.promptText.setText(canSea?'Premi M o tocca ▶ Vai al Mare':'Riempi la barra pupù (≥60%)');

        // Limiti verticali stabili
        this.player.y = Phaser.Math.Clamp(this.player.y, height*0.30, height-20);
        // Anim switch quando entri/esci dal mare
        const want = GameState.selected.genere==='f'
          ? (inWater?'swim_f':'walk_f') : (inWater?'swim_m':'walk_m');
        if(this.player.anims.currentAnim?.key!==want) this.player.play(want,true);

        // Fail/win immediati
        if(GameState.poop>=1.0 || GameState.stomach>=1.0){
          SFX.lose(); Haptics.lose();
          this.scene.start('LoseScene',{reason:(GameState.poop>=1.0)?'overeat':'stomachache'});
        }
      }
    }

    /* -------------------------------------------------------------
     *  Sea (spiaggia in alto) — con manica a vento
     * ----------------------------------------------------------- */
    class SeaScene extends Phaser.Scene{
      constructor(){ super('SeaScene'); }
      create(){
        showToolbar(); GameState.transitioning=false;
        const {width,height}=this.scale;
        this.cameras.main.setBackgroundColor('#3CB7E7');

        const M=R.metricsFor(this); this.beachHeight = M.beachHeight; this.beachBottomY = this.beachHeight;
        const g=this.add.graphics(); g.fillStyle(0xF4E2B5,1).fillRect(0,0,width,this.beachHeight); g.fillStyle(0x3CB7E7,1).fillRect(0,this.beachHeight,width,height-this.beachHeight);

        const baseSize = (height>=width) ? 60 : 52;
        const scaleP = baseSize / SHEET.cell;
        const player=this.add.sprite(width*0.5,this.beachBottomY+60,SHEET.key,'12').setScale(scaleP);
        this.player=player; this.physics.add.existing(player); player.body.setCircle(player.displayWidth/2).setCollideWorldBounds(true);
        player.play(GameState.selected.genere==='f' ? 'swim_f' : 'swim_m');

        // corrente + windsock
        this.currentAngle=Phaser.Math.FloatBetween(-Math.PI,Math.PI);
        this.currentSpeed=38; this.currentFrozen=false;
        this.currentGfx=this.add.graphics();
        this.scheduleNextCurrentChange();

        // gruppi & bonus
        this.poops=this.add.group(); this.narwhals=[]; this.swimmers=[]; this.seaBonuses=this.physics.add.group();

        // bagnino
        this.lifeguard={ x:width/2, y:this.beachBottomY-22, dir: Math.PI/2, fov: Phaser.Math.DegToRad(50), range: 360 };
        this.visionGfx=this.add.graphics(); this.add.text(this.lifeguard.x,this.lifeguard.y,'🛟',{fontSize:24}).setOrigin(0.5).setDepth(5);

        // nuotatori
        for(let i=0;i<6;i++){
          const x=Phaser.Math.Between(60,width-60), y=Phaser.Math.Between(this.beachBottomY+70, height-90);
          const s=this.add.text(x,y, i%2===0?'🏊‍♂️':'🏊‍♀️',{fontSize:22}).setOrigin(0.5);
          this.physics.add.existing(s); s.body.setCircle(12).setCollideWorldBounds(true);
          this.swimmers.push({ sprite:s, dir:Phaser.Math.FloatBetween(-Math.PI,Math.PI), speed:42, fov:Phaser.Math.DegToRad(40), range:140, changeAt:0 });
        }

        const bottomMargin=110;
        ['narwhal','siren','tornado'].forEach(t=>this.spawnSeaBonus(t,bottomMargin));
        this.spawnCrabBonus();

        this.tornado=null; this.tornadoGfx=this.add.graphics().setDepth(4);

        // HUD
        this.ui=this.add.graphics().setDepth(10);
        this.poopText=this.add.text(0,0,'',{fontFamily:FONT,fontSize:14,color:'#ffffff'}).setOrigin(1,0).setStroke('#111',4).setShadow(2,2,'#000',4).setDepth(10);
        this.stomachText=this.add.text(0,0,'',{fontFamily:FONT,fontSize:14,color:'#ffffff'}).setOrigin(1,0).setStroke('#111',4).setShadow(2,2,'#000',4).setDepth(10);

        // input
        this.cursors=this.input.keyboard.createCursorKeys(); this.wasd=this.input.keyboard.addKeys('W,A,S,D');
        this.keySpace=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
        this.keyS=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
        this.keyN=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.N);
        this.keyT=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.T);
        this.pointerTarget=null; this.pointerMarker=this.add.circle(0,0,8,0x000000,0.25).setVisible(false).setDepth(9);
        const setPtr=(p)=>{ this.pointerTarget={x:p.worldX,y:p.worldY}; this.pointerMarker.setPosition(this.pointerTarget.x,this.pointerTarget.y).setVisible(true); };
        this.input.on('pointerdown',setPtr); this.input.on('pointermove',(p)=>{ if(p.isDown) setPtr(p); });

        this.physics.add.overlap(this.player,this.seaBonuses,(player,b)=>{
          if(b.type==='narwhal'){ GameState.hasNarwhal=true; SFX.narwhal(); Haptics.bonusPickup(); }
          if(b.type==='siren'){   GameState.hasSiren=true;   SFX.siren();   Haptics.bonusPickup(); }
          if(b.type==='tornado'){ GameState.hasTornado=true; SFX.tornado(); Haptics.bonusPickup(); }
          if(b.type==='crab'){    GameState.crabsFriendly=true; SFX.crab();  Haptics.bonusPickup(); }
          this.tweens.add({targets:b,angle:360,scale:1.5,duration:240,onComplete:()=>b.destroy()});
        });

        // granchi (sabbia soltanto)
        this.crabs=[]; this.crabGfx=this.add.graphics().setDepth(4); this.CRAB_VISION_R=28;
        this.spawnCrabs(6);

        wireToolbarToSeaScene(this);
      }
      scheduleNextCurrentChange(){
        const nextMs=Phaser.Math.Between(12000,20000);
        this.time.delayedCall(nextMs,()=>{ if(!this.currentFrozen) this.currentAngle=Phaser.Math.FloatBetween(-Math.PI,Math.PI); this.scheduleNextCurrentChange(); });
      }
      spawnSeaBonus(type, bottomMargin=110){
        const {width,height}=this.scale;
        const x=Phaser.Math.Between(40,width-40), y=Phaser.Math.Between(this.beachBottomY+70, Math.max(this.beachBottomY+120, height-bottomMargin-20));
        const label = type==='narwhal'?'🐋':type==='siren'?'🧜‍♀️':'🌀';
        const b=this.add.text(x,y,label,{fontFamily:FONT,fontSize:22}).setOrigin(0.5).setDepth(6);
        this.physics.add.existing(b); b.body.setCircle(16).setOffset(-16,-16); b.body.setImmovable(true); b.type=type; this.seaBonuses.add(b);
      }
      spawnCrabBonus(){
        const { width } = this.scale;
        const x=Phaser.Math.Between(40,width-40), y=Phaser.Math.Between(24, this.beachBottomY-24);
        const b=this.add.text(x,y,'🪙',{fontSize:20}).setOrigin(0.5).setDepth(6);
        this.physics.add.existing(b); b.body.setCircle(16).setOffset(-16,-16); b.body.setImmovable(true); b.type='crab'; this.seaBonuses.add(b);
      }
      spawnCrabs(n=6){
        for(let i=0;i<n;i++){
          const x=Phaser.Math.Between(20,this.scale.width-20);
          const y=Phaser.Math.Between(12,this.beachBottomY-12);
          const t=this.add.text(x,y,'🦀',{fontSize:22}).setOrigin(0.5).setDepth(6);
          this.physics.add.existing(t); t.body.setCircle(12).setCollideWorldBounds(true);
          const crab={ sprite:t, dir:Phaser.Math.FloatBetween(-Math.PI,Math.PI), speed:34, changeAt:0, friend:false };
          this.crabs.push(crab);
        }
      }
      triggerNarwhal(){ if(!GameState.hasNarwhal) return; const n=this.add.text(this.player.x,this.player.y,'🐋',{fontSize:24}).setDepth(7); n._speed=90; n._target=this.nearestPoop(n); this.narwhals.push(n); GameState.hasNarwhal=false; SFX.narwhal(); Haptics.bonusUse(); }
      triggerSiren(){ if(!GameState.hasSiren) return; GameState.hasSiren=false; const siren=this.add.text(this.player.x,this.player.y,'🧜‍♀️',{fontSize:24}).setDepth(7); this.time.delayedCall(15000,()=>siren.destroy()); SFX.siren(); Haptics.bonusUse(); }
      triggerTornado(){ if(!GameState.hasTornado) return; GameState.hasTornado=false; this.tornado={x:this.player.x,y:this.player.y,until:this.time.now+15000}; SFX.tornado(); Haptics.bonusUse(); }
      dropPoop(){ if(GameState.poop<=0) return; const chunk=Math.min(GameState.poop,0.2); GameState.poop=Math.max(0,GameState.poop-chunk); const p=this.add.text(this.player.x,this.player.y,'💩',{fontSize:20}).setDepth(8); p._tDrop=this.time.now; p._ttlMs=60000; p._stranded=false; p._label=this.add.text(p.x,p.y-18,'60',{fontSize:12,color:'#001'}).setOrigin(0.5).setDepth(8); this.poops.add(p); SFX.drop(); }

      nearestPoop(from){ let best=null, dBest=1e9; this.poops.getChildren().forEach(p=>{ if(!p.active) return; const d=Phaser.Math.Distance.Between(from.x,from.y,p.x,p.y); if(d<dBest){ best=p; dBest=d; } }); return best; }

      update(time,delta){
        const dt=delta/1000, {width,height}=this.scale;
        const body=this.player.body; body.setVelocity(0);
        const onBeach=(this.player.y <= this.beachBottomY);
        const speed=onBeach?150:120;

        if (this.cursors.left.isDown||this.wasd.A.isDown) body.setVelocityX(-speed); else if (this.cursors.right.isDown||this.wasd.D.isDown) body.setVelocityX(speed);
        if (this.cursors.up.isDown||this.wasd.W.isDown) body.setVelocityY(-speed); else if (this.cursors.down.isDown||this.wasd.S.isDown) body.setVelocityY(speed);
        if (this.pointerTarget){ const dx=this.pointerTarget.x-this.player.x, dy=this.pointerTarget.y-this.player.y, dist=Math.hypot(dx,dy); if(dist>6) body.setVelocity((dx/dist)*speed,(dy/dist)*speed); else { this.pointerTarget=null; this.pointerMarker.setVisible(false);} }

        const cx=Math.cos(this.currentAngle)*this.currentSpeed, cy=Math.sin(this.currentAngle)*this.currentSpeed;
        if(!onBeach){ body.velocity.x += cx; body.velocity.y += cy; }

        // manica a vento alto contrasto
        this.currentGfx.clear();
        const baseX=48, baseY=48, ang=this.currentAngle, len=48;
        this.currentGfx.lineStyle(6,0x222222,1).lineBetween(baseX, baseY+28, baseX, baseY-28);
        this.currentGfx.lineStyle(4,0xffffff,1).lineBetween(baseX-2, baseY+28, baseX-2, baseY-28);
        const endX=baseX + Math.cos(ang)*len, endY=baseY + Math.sin(ang)*len;
        this.currentGfx.lineStyle(4,0x111111,0.9).lineBetween(baseX, baseY, endX, endY);
        const segs=4; for(let s=0;s<segs;s++){ const t0=s/segs;
          const sx0=baseX + Math.cos(ang)*len*t0, sy0=baseY + Math.sin(ang)*len*t0;
          this.currentGfx.save(); this.currentGfx.translate(sx0,sy0); this.currentGfx.rotate(ang);
          this.currentGfx.fillStyle((s%2===0)?0xff2b2b:0xffffff,1);
          this.currentGfx.fillRoundedRect(0,-8,(len/segs),16,6);
          this.currentGfx.restore();
        }

        // narvali inseguono 💩, tornado area, ecc. (come prima)
        if(this.tornado && time>=this.tornado.until){ this.tornado=null; this.tornadoGfx.clear(); }
        this.tornadoGfx.clear(); if(this.tornado){ this.tornadoGfx.lineStyle(3,0x00695c,0.9); this.tornadoGfx.strokeCircle(this.tornado.x,this.tornado.y,24); this.tornadoGfx.strokeCircle(this.tornado.x,this.tornado.y,12); this.tornadoGfx.strokeCircle(this.tornado.x,this.tornado.y,36); }

        for(const n of this.narwhals||[]){ if(!n.active) continue; if(!n._target || !n._target.active) n._target=this.nearestPoop(n); if(n._target){ const dx=n._target.x-n.x, dy=n._target.y-n.y, d=Math.hypot(dx,dy)||1; n.x+=(dx/d)*90*dt+cx*dt; n.y+=(dy/d)*90*dt+cy*dt; if(d<10 && n._target.active){ n._target._label?.destroy(); n._target.destroy(); n._target=this.nearestPoop(n); SFX.narwhal(); } } else { n.x+=cx*dt; n.y+=cy*dt; n._despawnAt=n._despawnAt||(time+2000); if(time>=n._despawnAt) n.destroy(); } }

        this.poops.getChildren().forEach(p=>{
          const nowOnBeach=(p.y<=this.beachBottomY);
          if(!p._stranded && !nowOnBeach){ p.x += cx*dt; p.y += cy*dt; }
          if(nowOnBeach) p._stranded=true;
          p._label?.setPosition(p.x,p.y-18);
          const left=Math.max(0,Math.ceil((p._ttlMs - (time - p._tDrop))/1000)); p._label?.setText(left.toString());
          if(left<=0 && p.active){ p._label?.destroy(); p.destroy(); }
          p.x=Phaser.Math.Clamp(p.x,8,width-8);
          p.y=Phaser.Math.Clamp(p.y,60,height-8);
        });

        // detection & esiti
        if(this.isAnyPoopDetected()){ SFX.lose(); Haptics.lose(); resetForNewRun(); this.scene.start('LoseScene',{reason:'detected'}); return; }
        if(GameState.poop<=0 && this.poops.countActive(true)===0){ SFX.win(); Haptics.win(); resetForNewRun(); this.scene.start('WinScene'); return; }

        // HUD destro
        const barW=220, barH=22, pad=16, xRight=width-barW-pad;
        this.ui.clear();
        drawProgressBar(this.ui,xRight,12,barW,barH,GameState.poop,0x9b5a1a);
        drawProgressBar(this.ui,xRight,12+barH+6,barW,barH,GameState.stomach,0xcc3333);
        this.poopText.setPosition(xRight+barW,12).setText(`Pupù: ${Math.round(GameState.poop*100)}%`);
        this.stomachText.setPosition(xRight+barW,12+barH+6).setText(`Mal di pancia: ${Math.round(GameState.stomach*100)}%`);

        if(Phaser.Input.Keyboard.JustDown(this.keySpace)) this.dropPoop();
        if(Phaser.Input.Keyboard.JustDown(this.keyS)) this.triggerSiren();
        if(Phaser.Input.Keyboard.JustDown(this.keyN)) this.triggerNarwhal();
        if(Phaser.Input.Keyboard.JustDown(this.keyT)) this.triggerTornado();
      }

      drawCone(gfx,x,y,dir,fov,range,color,alpha){
        gfx.fillStyle(color,alpha);
        const a1=dir-fov/2, a2=dir+fov/2, p1={x:x+Math.cos(a1)*range,y:y+Math.sin(a1)*range}, p2={x:x+Math.cos(a2)*range,y:y+Math.sin(a2)*range};
        gfx.beginPath(); gfx.moveTo(x,y); gfx.lineTo(p1.x,p1.y); gfx.arc(x,y,range,a1,a2); gfx.lineTo(x,y); gfx.closePath(); gfx.fillPath();
      }
      isAnyPoopDetected(){
        for(const p of this.poops.getChildren()){
          if(!p.active) continue;
          if(this.inCone({x:this.lifeguard.x,y:this.lifeguard.y}, Math.PI/2,Phaser.Math.DegToRad(50),360, p)) return true;
          for(const s of this.swimmers){ if(this.inCone({x:s.sprite.x,y:s.sprite.y}, s.dir,s.fov,s.range, p)) return true; }
        }
        if(!GameState.crabsFriendly){
          for(const c of this.crabs){
            for(const p of this.poops.getChildren()){
              if(!p.active) continue;
              const d=Phaser.Math.Distance.Between(c.sprite.x,c.sprite.y,p.x,p.y);
              if(d <= this.CRAB_VISION_R) return true;
            }
          }
        }
        return false;
      }
      inCone(o,dir,fov,range,p){ const dx=p.x-o.x, dy=p.y-o.y, dist=Math.hypot(dx,dy); if(dist>range) return false; const ang=Math.atan2(dy,dx); let diff=ang-dir; diff=Math.atan2(Math.sin(diff),Math.cos(diff)); return Math.abs(diff)<=fov/2; }
    }

    /* -------------------------------------------------------------
     *  Lose / Win
     * ----------------------------------------------------------- */
    class LoseScene extends Phaser.Scene{
      constructor(){ super('LoseScene'); }
      create(data){
        hideToolbar();
        const {width,height}=this.scale; this.cameras.main.setBackgroundColor('#222');
        let title='Ops! Sei stato scoperto! 🚨';
        if(data?.reason==='overeat'||data?.reason==='stomachache'){ title='Oh no! Hai mangiato troppo e ti sei fatto cacca addosso! 💥💩'; }
        this.add.text(width/2,height/2-40,title,{fontFamily:FONT,fontSize:24,color:'#fff',align:'center',wordWrap:{width:Math.min(600,width-40)}}).setOrigin(0.5);
        this.add.text(width/2-130,height-60,'⬅ Menu',{fontFamily:FONT,fontSize:22,color:'#fff',backgroundColor:'#444',padding:{left:10,right:10,top:6,bottom:6}})
          .setOrigin(0.5).setInteractive({useHandCursor:true}).on('pointerdown',()=>{ resetForNewRun(); this.scene.start('MenuScene'); });
        this.add.text(width/2+130,height-60,'⟲ Riprova',{fontFamily:FONT,fontSize:22,color:'#fff',backgroundColor:'#444',padding:{left:10,right:10,top:6,bottom:6}})
          .setOrigin(0.5).setInteractive({useHandCursor:true}).on('pointerdown',()=>{ resetForNewRun(); this.scene.start('LandScene'); });
      }
    }
    class WinScene extends Phaser.Scene{
      constructor(){ super('WinScene'); }
      create(){
        hideToolbar();
        const {width,height}=this.scale; this.cameras.main.setBackgroundColor('#1b5e20');
        this.add.text(width/2, height/2 - 40, 'Ce l\'hai fatta! 🤫🌊', { fontFamily:FONT, fontSize: 28, color:'#ffffff' }).setOrigin(0.5);
        this.add.text(width/2, height/2 + 10, 'Nessuno ha scoperto nulla. Bravo stratega!', { fontFamily:FONT, fontSize: 16, color:'#e8f5e9' }).setOrigin(0.5);
        this.add.text(width/2 - 130, height - 60, '⬅ Menu', { fontFamily:FONT, fontSize:22, color:'#fff', backgroundColor:'#2e7d32', padding:{left:10,right:10,top:6,bottom:6} })
          .setOrigin(0.5).setInteractive({useHandCursor:true}).on('pointerdown', ()=>{ resetForNewRun(); this.scene.start('MenuScene'); });
        this.add.text(width/2 + 130, height - 60, '⟲ Gioca ancora', { fontFamily:FONT, fontSize:22, color:'#fff', backgroundColor:'#2e7d32', padding:{left:10,right:10,top:6,bottom:6} })
          .setOrigin(0.5).setInteractive({useHandCursor:true}).on('pointerdown', ()=>{ resetForNewRun(); this.scene.start('LandScene'); });
      }
    }

    /* -------------------------------------------------------------
     *  Toolbar e util
     * ----------------------------------------------------------- */
    function showToolbar(){ document.getElementById('toolbar').style.display='flex'; }
    function hideToolbar(){ document.getElementById('toolbar').style.display='none'; }
    function wireToolbarToSeaScene(){
      const g=window.PooPooPanda._game;
      const btn=(id)=>document.getElementById(id);
      const call=(fn)=>()=>{ const s=g?.scene?.getScene('SeaScene'); if(!s||!s.scene.isActive()) return; fn(s); };
      btn('btn-menu').onclick=call(s=>{ resetForNewRun(); s.scene.start('MenuScene'); SFX.button(); });
      btn('btn-restart').onclick=call(s=>{ resetForNewRun(); s.scene.start('LandScene'); SFX.button(); });
      btn('btn-poop').onclick=call(s=>{ s.dropPoop(); SFX.drop(); });
      btn('btn-narwhal').onclick=call(s=>{ s.triggerNarwhal(); Haptics.bonusUse(); });
      btn('btn-siren').onclick=call(s=>{ s.triggerSiren(); Haptics.bonusUse(); });
      btn('btn-tornado').onclick=call(s=>{ s.triggerTornado(); Haptics.bonusUse(); });
    }
    function labelForFood(t){ return t===Foods.BAMBOO?'🎋 Bamboo':t===Foods.PASTA?'🍝 Pasta':t===Foods.PIZZA?'🍕 Pizza':t===Foods.GELATO?'🍦 Gelato':'Cibo'; }
    function colorForFood(t){ return t===Foods.BAMBOO?'#1f7a1f':t===Foods.PASTA?'#7a5d1f':t===Foods.PIZZA?'#a83232':t===Foods.GELATO?'#7a1f6a':'#333'; }
    function randomPointAvoiding(center,minDist,b){ for(let i=0;i<50;i++){ const x=Math.floor(Math.random()*(b.xMax-b.xMin+1))+b.xMin; const y=Math.floor(Math.random()*(b.yMax-b.yMin+1))+b.yMin; if(Math.hypot(x-center.x,y-center.y)>=minDist) return {x,y}; } return {x:b.xMin,y:b.yMin}; }

    // Fullscreen
    function toggleFull(){ const game=window.PooPooPanda._game; if(!game) return; const scale=game.scale; if(scale.isFullscreen) scale.stopFullscreen(); else scale.startFullscreen(); }
    document.getElementById('btn-full').addEventListener('click', toggleFull);

    // Audio unlock overlay
    function setupAudioUnlock(){ const gate=document.getElementById('audio-gate'), btn=document.getElementById('audio-btn'); if(!gate||!btn) return; gate.style.display='flex'; const unlock=()=>{ try{ ensureAudioContext().resume(); }catch{} gate.style.display='none'; window.removeEventListener('pointerdown',unlock); }; btn.addEventListener('click',unlock); window.addEventListener('pointerdown',unlock,{once:true}); }

    // Fix per 100vh su iOS vecchi
    function fixVH(){ const h=window.innerHeight; document.documentElement.style.setProperty('--vhpx', h + 'px'); }
    window.addEventListener('resize', fixVH); fixVH();

    // Avvio Phaser
    function createGame(parent='game-container'){
      const config={
        type: Phaser.AUTO, width: 960, height: 540, backgroundColor:'#0d1117', parent,
        scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
        render: { pixelArt:true, roundPixels:true, antialias:false },
        physics:{ default:'arcade', arcade:{ gravity:{y:0}, debug:false } },
        scene:[BootScene,MenuScene,LandScene,SeaScene,LoseScene,WinScene]
      };
      return new Phaser.Game(config);
    }

    window.PooPooPanda={ createGame };
    window.addEventListener('DOMContentLoaded', ()=>{
      const el=document.getElementById('game-container');
      if(el) window.PooPooPanda._game=createGame('game-container');
      wireToolbarToSeaScene();
      setupAudioUnlock();
    });
  </script>
</body>
</html>
